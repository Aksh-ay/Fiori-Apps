
<!-- webapp/fragment/ChartOptions.fragment.xml -->
<core:FragmentDefinition
  xmlns="sap.m"
  xmlns:core="sap.ui.core"
  xmlns:layout="sap.ui.layout"
  xmlns:vizc="sap.viz.ui5.controls"
  xmlns:vizdata="sap.viz.ui5.data">

  <Dialog id="chartOptionsDialog"
          title="Build Chart"
          contentWidth="56rem"
          contentHeight="38rem"
          afterClose=".onChartDialogAfterClose">

    <!-- SETTINGS -->
    <VBox class="sapUiMediumMargin">
      <HBox justifyContent="SpaceBetween" alignItems="Center" class="sapUiSmallMarginBottom">
        <!-- Chart Type -->
        <VBox width="33%">
          <Label text="Chart Type" labelFor="cbChartType"/>
          <ComboBox id="cbChartType"
                    width="12rem"
                    selectedKey="{chartMeta>/ChartType}"
                    selectionChange=".onChartTypeChange">
            <core:Item key="column"      text="Column"/>
            <core:Item key="bar"         text="Bar"/>
            <core:Item key="line"        text="Line"/>
            <core:Item key="pie"         text="Pie"/>
            <core:Item key="donut"       text="Donut"/>
            <core:Item key="dual_column" text="Dual Column (Quantity + USD)"/>
          </ComboBox>
        </VBox>

        <!-- Measure -->
        <VBox width="33%">
          <Label text="Measure" labelFor="sbMeasure"/>
          <SegmentedButton id="sbMeasure"
                           width="100%"
                           selectionChange=".onMeasureChange"
                           enabled="{= ${chartMeta>/ChartType} !== 'dual_column' }"
                           selectedKey="{chartMeta>/Measure}">
            <items>
              <SegmentedButtonItem key="Quantity"  text="Quantity"/>
              <SegmentedButtonItem key="USD Value" text="USD Value"/>
            </items>
          </SegmentedButton>
        </VBox>

        <!-- Dimension (against which column) -->
        <VBox width="33%">
          <Label text="Against (Dimension)" labelFor="cbDimension"/>
          <ComboBox id="cbDimension"
                    width="100%"
                    selectedKey="{chartMeta>/DimensionKey}"
                    selectionChange=".onDimensionChange"
                    items="{ path: 'chartMeta>/Dimensions' }">
            <core:Item key="{chartMeta>key}" text="{chartMeta>text}"/>
          </ComboBox>
        </VBox>
      </HBox>

      <!-- NEW: Optional Year selector when Dimension is Month or Quarter/Quater -->
      <HBox class="sapUiSmallMarginTop"
            visible="{= ${chartMeta>/DimensionKey} === 'Month' || ${chartMeta>/DimensionKey} === 'Quarter' || ${chartMeta>/DimensionKey} === 'Quater' }">
        <VBox width="33%">
          <Label text="Year (optional for Month/Quarter)" labelFor="cbYearForPeriod"/>
          <ComboBox id="cbYearForPeriod"
                    width="12rem"
                    selectedKey="{chartMeta>/YearForPeriod}"
                    selectionChange=".onYearForPeriodChange"
                    showSecondaryValues="false"
                    items="{ path: 'chartMeta>/YearOptions' }">
            <core:Item key="{chartMeta>key}" text="{chartMeta>text}"/>
          </ComboBox>
          <Text text="Leave empty to aggregate across all years." class="sapUiTinyMarginTop sapUiContentLabelColor"/>
        </VBox>
      </HBox>
    </VBox>

    <!-- PREVIEW -->
    <VBox class="sapUiMediumMarginTop">
      <Text class="sapUiTinyMarginBottom"
            text="{= 'Type: ' + ${chartMeta>/ChartType}
                    + ' | Measure: ' + ${chartMeta>/Measure}
                    + ' | Dimension: ' + (${chartMeta>/DimensionKey} || '-')
                    + ( (${chartMeta>/DimensionKey} === 'Month' || ${chartMeta>/DimensionKey} === 'Quarter' || ${chartMeta>/DimensionKey} === 'Quater')
                        ? (' | Year: ' + (${chartMeta>/YearForPeriod} || 'All'))
                        : '' ) }"/>

      <vizc:VizFrame id="vfSales"
                     width="100%"
                     height="22rem"
                     vizType="{chartMeta>/ChartType}"
                     uiConfig="{applicationSet:'fiori'}">
        <vizc:dataset>
          <vizdata:FlattenedDataset data="{chartModel>/ChartData}">
            <vizdata:dimensions>
              <vizdata:DimensionDefinition name="Dimension" value="{chartModel>Dimension}" />
            </vizdata:dimensions>
            <vizdata:measures>
              <vizdata:MeasureDefinition name="Quantity"  value="{chartModel>Quantity}" />
              <vizdata:MeasureDefinition name="USD Value" value="{chartModel>USDValue}" />
            </vizdata:measures>
          </vizdata:FlattenedDataset>
        </vizc:dataset>
        <vizc:feeds/>
      </vizc:VizFrame>

      <vizc:Popover id="vfPopover"/>
    </VBox>

    <!-- Buttons -->
    <beginButton>
      <Button text="Close" type="Transparent" press=".onChartDialogCancel"/>
    </beginButton>

  </Dialog>
</core:FragmentDefinition>
